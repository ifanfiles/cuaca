<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Prakiraan Cuaca Per Kabupaten</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: Arial; margin:0; padding:0; }
    #map { height: 500px; width: 60%; float:left; }
    #table { width: 38%; float:right; padding:10px; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h2 style="text-align:center">Prakiraan Cuaca Umum Per Kabupaten</h2>
  <div id="map"></div>
  <div id="table">
    <table id="forecastTable">
      <thead>
        <tr>
          <th>No</th>
          <th>Kabupaten</th>
          <th>Cuaca Dominan</th>
          <th>Suhu (Â°C)</th>
          <th>Kelembapan (%)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([-7.5, 110], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Load GeoJSON batas kabupaten
    fetch("batas_wilayah.geojson")
      .then(res => res.json())
      .then(geojson => {
        L.geoJSON(geojson, {
          style: { color:"blue", weight:1, fillOpacity:0.1 },
          onEachFeature: (feature, layer) => {
            layer.bindPopup(feature.properties.KABUPATEN);
          }
        }).addTo(map);

        // Proses per kabupaten
        processForecast(geojson);
      });

    async function processForecast(geojson){
      let tbody = document.querySelector("#forecastTable tbody");
      let kabList = geojson.features;

      let no = 1;
      for (let kab of kabList){
        let namaKab = kab.properties.KABUPATEN;
        let adm4List = kab.properties.ADM4_LIST; 
        // asumsi di GeoJSON ada array kode adm4 di properties.ADM4_LIST

        let result = await aggregateKabupaten(adm4List);

        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${no++}</td>
                        <td>${namaKab}</td>
                        <td>${result.cuaca}</td>
                        <td>${result.suhu}</td>
                        <td>${result.hum}</td>`;
        tbody.appendChild(tr);
      }
    }

    // Fungsi agregasi
    async function aggregateKabupaten(adm4List){
      let allCuaca = [];
      let allSuhu = [];
      let allHum = [];

      for (let kode of adm4List){
        let url = `https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=${kode}`;
        try {
          let res = await fetch(url);
          let json = await res.json();
          let cuaca = json.data[0].cuaca[0]; // jam pertama
          allCuaca.push(cuaca.weather_desc);
          allSuhu.push(Number(cuaca.t));
          allHum.push(Number(cuaca.hu));
        } catch(e){
          console.warn("Gagal fetch", kode, e);
        }
      }

      // Hitung mayoritas cuaca
      let count = {};
      allCuaca.forEach(c => { count[c] = (count[c]||0)+1 });
      let cuacaDominan = Object.entries(count).sort((a,b)=>b[1]-a[1])[0][0];

      // Rata-rata suhu & kelembapan
      let avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
      let suhu = (avg(allSuhu)||0).toFixed(1);
      let hum = (avg(allHum)||0).toFixed(1);

      return {cuaca: cuacaDominan, suhu, hum};
    }
  </script>
</body>
</html>
