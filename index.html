<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Prakiraan Cuaca BMKG</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-bottom: 5px; }
    .container { display: flex; gap: 20px; align-items: flex-start; }
    table { border-collapse: collapse; width: 400px; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
    th { background: #f0f0f0; }
    .chart-container { flex: 1; }
    .location { margin-bottom: 15px; }
    input, button { padding: 6px; font-size: 14px; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Prakiraan Cuaca BMKG</h2>

  <!-- Input kode ADM4 -->
  <div>
    <label>Masukkan kode ADM4: </label>
    <input type="text" id="admInput" value="34.02.07.2001">
    <button onclick="loadWeather()">Tampilkan</button>
  </div>

  <!-- Info lokasi -->
  <div class="location" id="locationInfo"></div>

  <!-- Container tabel + chart -->
  <div class="container">
    <table id="weatherTable">
      <thead>
        <tr>
          <th>Jam</th>
          <th>Cuaca</th>
          <th>Suhu</th>
          <th>Kelembapan</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="chart-container">
      <canvas id="weatherChart"></canvas>
    </div>
  </div>

  <script>
    let chart; // simpan chart global

    async function loadWeather() {
      const admCode = document.getElementById("admInput").value;
      const url = `https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=${admCode}`;
      
      try {
        const res = await fetch(url);
        const data = await res.json();

        // tampilkan info lokasi
        const loc = data.lokasi;
        document.getElementById("locationInfo").innerHTML = `
          <b>Provinsi:</b> ${loc.provinsi} <br>
          <b>Kab/Kota:</b> ${loc.kotkab} <br>
          <b>Kecamatan:</b> ${loc.kecamatan} <br>
          <b>Desa:</b> ${loc.desa}
        `;

        // ambil semua data cuaca
        const cuacaData = data.data.flatMap(d => d.cuaca);

        // isi tabel
        const tbody = document.querySelector("#weatherTable tbody");
        tbody.innerHTML = "";
        const times = [], temps = [], hums = [];

        cuacaData.forEach(item => {
          const jam = new Date(item.local_datetime).toLocaleTimeString("id-ID", {
            hour: "2-digit", minute:"2-digit"
          });
          tbody.innerHTML += `
            <tr>
              <td>${jam}</td>
              <td>${item.weather_desc}</td>
              <td>${item.t}°C</td>
              <td>${item.hu}%</td>
            </tr>
          `;
          times.push(jam);
          temps.push(item.t);
          hums.push(item.hu);
        });

        // update chart
        const ctx = document.getElementById("weatherChart").getContext("2d");
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: times,
            datasets: [
              { label: "Suhu (°C)", data: temps, borderColor: "red", fill: false },
              { label: "Kelembapan (%)", data: hums, borderColor: "blue", fill: false }
            ]
          }
        });

      } catch (err) {
        console.error("Gagal ambil data:", err);
        alert("Data tidak tersedia untuk kode ADM4 ini.");
      }
    }

    // otomatis load pertama kali
    loadWeather();
  </script>
</body>
</html>
