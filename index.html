<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Viewer Prakiraan Cuaca</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial,Segoe UI,Roboto; margin:16px; background:#f6f8fb; color:#111}
    h1{margin:0 0 8px;text-align:center}
    .top {display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:12px}
    select,input,button{padding:8px 10px;border-radius:8px;border:1px solid #d0d7e0}
    .card {background:#fff;border-radius:10px;padding:12px;box-shadow:0 4px 18px rgba(18,38,63,0.06)}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
    th,td{padding:8px 6px;border-bottom:1px solid #eee;text-align:left}
    th{background:#f3f6fb;position:sticky;top:0}
    .small{font-size:12px;color:#666}
    .muted{color:#666;font-size:13px}
    button {
      background:#2c7be5;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;
    }
    button:hover { background:#1a5fb4; }
  </style>
</head>
<body>
  <h1>Prakiraan Cuaca Per Kabupaten</h1>

  <div class="top card">
    <label>File JSON:
      <input id="dataFile" type="text" value="prakiraan_kabupaten_full3jam.json" style="width:260px" />
    </label>
    <button id="loadBtn">Muat Data</button>

    <label>Kabupaten:
      <select id="kabSelect" style="min-width:260px"></select>
    </label>

    <label>Mode Tampilan:
      <select id="modeSelect">
        <option value="slot">Slot 3-jam</option>
        <option value="harian">Agregasi Harian</option>
      </select>
    </label>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
      <div class="muted" id="metaInfo">Belum memuat data</div>
      <div class="small">Jumlah baris: <span id="rowCount">0</span></div>
    </div>

    <div style="overflow:auto;max-height:560px">
      <table id="table">
        <thead id="thead"></thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="small muted">Belum ada data — klik "Muat Data"</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
let RAW = null;

// prioritas cuaca
const priority = {
  "Hujan Lebat": 5,
  "Hujan Sedang": 4,
  "Hujan Ringan": 3,
  "Berawan": 2,
  "Cerah Berawan": 2,
  "Cerah": 1
};
function pilihCuaca(arr){
  if(!arr.length) return "-";
  return arr.reduce((a,b)=> (priority[b]||0)>(priority[a]||0)?b:a,"-");
}

// parsing tanggal dari label
function extractDate(label){
  const m = label.match(/(\d{2}) (\w{3}) (\d{4})/); // ex: 05 Sep 2025
  return m ? m[0] : label;
}

async function loadAndPrepare(fileName){
  try {
    const res = await fetch(fileName,{cache:'no-store'});
    if(!res.ok) throw new Error("HTTP "+res.status);
    RAW = await res.json();
  } catch(e){
    alert("Gagal load JSON: "+e.message);
    return;
  }
  populateKabupatenSelect();
  document.getElementById("metaInfo").textContent = 
    `Terbaca ${Object.keys(RAW).length} kabupaten`;
}

function populateKabupatenSelect(){
  const sel = document.getElementById("kabSelect");
  sel.innerHTML="";
  const names = Object.keys(RAW).sort();
  names.forEach(n=>{
    const opt=document.createElement("option");
    opt.value=n; opt.textContent=n;
    sel.appendChild(opt);
  });
  sel.addEventListener("change",()=>renderForKabupaten(sel.value));
  document.getElementById("modeSelect").addEventListener("change",()=>renderForKabupaten(sel.value));
  if(names.length) renderForKabupaten(names[0]);
}

function renderForKabupaten(kab){
  const mode = document.getElementById("modeSelect").value;
  const tbody=document.getElementById("tbody");
  const thead=document.getElementById("thead");
  tbody.innerHTML="";
  const slotMap = RAW[kab]||{};
  let rows=[];

  if(mode==="slot"){ // tampil slot 3 jam
    thead.innerHTML="<tr><th>Waktu</th><th>Cuaca</th><th>Suhu (°C)</th><th>Kelembapan (%)</th></tr>";
    for(const label of Object.keys(slotMap)){
      const v=slotMap[label];
      rows.push({label,cuaca:v.cuaca,suhu:v.suhu,hum:v.hum});
    }
  } else { // agregasi harian
    thead.innerHTML="<tr><th>Tanggal</th><th>Cuaca Dominan</th><th>Suhu (°C)</th><th>Kelembapan (%)</th></tr>";
    const perHari={};
    for(const label of Object.keys(slotMap)){
      const v=slotMap[label];
      const tanggal = extractDate(label);
      if(!perHari[tanggal]) perHari[tanggal]={cuaca:[],suhu:[],hum:[]};
      perHari[tanggal].cuaca.push(v.cuaca);
      // parse suhu/hum range "22–25"
      if(v.suhu && v.suhu.includes("–")){
        const [a,b]=v.suhu.split("–").map(Number);
        if(!isNaN(a)&&!isNaN(b)){ perHari[tanggal].suhu.push(a,b); }
      }
      if(v.hum && v.hum.includes("–")){
        const [a,b]=v.hum.split("–").map(Number);
        if(!isNaN(a)&&!isNaN(b)){ perHari[tanggal].hum.push(a,b); }
      }
    }
    for(const tgl of Object.keys(perHari)){
      const d=perHari[tgl];
      const cuaca=pilihCuaca(d.cuaca);
      const suhu=d.suhu.length? `${Math.min(...d.suhu)}–${Math.max(...d.suhu)}`:"-";
      const hum=d.hum.length? `${Math.min(...d.hum)}–${Math.max(...d.hum)}`:"-";
      rows.push({label:tgl, cuaca, suhu, hum});
    }
  }

  if(!rows.length){
    tbody.innerHTML='<tr><td colspan="4" class="small muted">Tidak ada data</td></tr>';
  } else {
    rows.sort((a,b)=> a.label.localeCompare(b.label));
    tbody.innerHTML = rows.map(r=>`<tr>
      <td>${r.label}</td>
      <td>${r.cuaca}</td>
      <td>${r.suhu}</td>
      <td>${r.hum}</td>
    </tr>`).join("");
  }
  document.getElementById("rowCount").textContent=rows.length;
}

// event
document.getElementById("loadBtn").addEventListener("click",()=>{
  const f=document.getElementById("dataFile").value.trim();
  loadAndPrepare(f);
});
</script>
</body>
</html>
