<script>
  async function loadForecast() {
    const adm4 = document.getElementById("adm4").value.trim();
    const url = `https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=${adm4}`;

    try {
      const res = await fetch(url);
      const json = await res.json();

      // tampilkan JSON mentah buat debug
      document.getElementById("rawData").textContent = JSON.stringify(json, null, 2);

      const wilayah = json.data?.[0];  // ambil data pertama
      const lokasi = wilayah?.lokasi; // metadata wilayah
      const data = wilayah?.cuaca;

      console.log("Lokasi:", lokasi); // DEBUG ke console

      // ===== Metadata Wilayah =====
      if (lokasi) {
        const prov = lokasi.provinsi || "-";
        const kotkab = lokasi.kotkab || "-";
        const kec = lokasi.kecamatan || "-";
        const desa = lokasi.desa || "-";

        document.getElementById("meta").innerHTML = `
          <b>Provinsi:</b> ${prov} <br>
          <b>Kabupaten/Kota:</b> ${kotkab} <br>
          <b>Kecamatan:</b> ${kec} <br>
          <b>Desa/Kelurahan:</b> ${desa}
        `;

        // judul otomatis
        document.getElementById("titleArea").innerHTML = 
          `Prakiraan Cuaca untuk ${desa}, ${kec}, ${kotkab}`;
      } else {
        document.getElementById("meta").innerHTML = "<p>Data wilayah tidak tersedia.</p>";
        document.getElementById("titleArea").innerHTML = "";
      }

      if (!data) {
        document.getElementById("forecastTable").innerHTML = "<p>Tidak ada data prakiraan.</p>";
        return;
      }

      // Flatten array cuaca
      const flatData = data.flat();

      // ===== Tabel Cuaca =====
      let html = `
        <table>
          <thead>
            <tr>
              <th>Waktu Lokal</th>
              <th>Suhu (°C)</th>
              <th>Kelembapan (%)</th>
              <th>Cuaca</th>
              <th>Icon</th>
            </tr>
          </thead>
          <tbody>
      `;

      flatData.forEach(item => {
        html += `
          <tr>
            <td>${item.local_datetime}</td>
            <td>${item.t}</td>
            <td>${item.hu}</td>
            <td>${item.weather_desc}</td>
            <td><img src="${item.image}" width="40"></td>
          </tr>
        `;
      });

      html += "</tbody></table>";
      document.getElementById("forecastTable").innerHTML = html;

      // ===== Grafik Suhu & Kelembapan =====
      const labels = flatData.map(d => d.local_datetime);
      const suhu = flatData.map(d => d.t);
      const hum = flatData.map(d => d.hu);

      renderChart("tempChart", "Suhu (°C)", labels, suhu, "rgba(255,99,132,0.7)");
      renderChart("humChart", "Kelembapan (%)", labels, hum, "rgba(54,162,235,0.7)");

    } catch (err) {
      console.error(err);
      document.getElementById("forecastTable").innerHTML = "<p>Error mengambil data.</p>";
    }
  }
</script>
