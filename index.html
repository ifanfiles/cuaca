<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Prakiraan Cuaca DIY (slot 3-jam)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Segoe UI,Roboto; margin:16px; background:#f6f8fb; color:#111}
    h1{text-align:center; margin-bottom:12px}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
    select,button{padding:8px 10px;border-radius:6px;border:1px solid #ccc;background:#fff}
    .layout{display:grid;grid-template-columns:1fr 480px;gap:16px;align-items:start}
    .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
    th{background:#007acc;color:#fff;position:sticky;top:0}
    .muted{color:#666;font-size:13px}
    canvas{max-width:100%}
    .cuaca-cell{font-weight:bold;color:#000}
    .legend{margin-top:10px;font-size:13px}
    .legend-item{display:flex;align-items:center;margin:2px 0}
    .legend-box{width:20px;height:12px;margin-right:6px;border:1px solid #000}
    @media(max-width:940px){.layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>Prakiraan Cuaca DIY (slot 3-jam)</h1>

  <div class="controls">
    <label>Kabupaten:
      <select id="kabSelect"></select>
    </label>
    <label>Tanggal:
      <select id="dateSelect"></select>
    </label>
    <button id="toCsv">Download CSV</button>
  </div>

  <div class="layout">
    <div class="card">
      <div class="muted" id="info">Belum ada data</div>
      <div style="overflow:auto;max-height:560px">
        <table id="cuacaTable">
          <thead>
            <tr>
              <th>Waktu</th><th>Cuaca</th><th>Suhu (°C)</th><th>Kelembapan (%)</th>
            </tr>
          </thead>
          <tbody id="tbody"><tr><td colspan="4">...</td></tr></tbody>
        </table>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-box" style="background:#00FF00"></div> Hujan Ringan : 0.5 - 20 mm/jam</div>
        <div class="legend-item"><div class="legend-box" style="background:#FFFF00"></div> Hujan Sedang : 20 - 50 mm/jam</div>
        <div class="legend-item"><div class="legend-box" style="background:#FFA500"></div> Hujan Lebat : 50 - 100 mm/jam</div>
        <div class="legend-item"><div class="legend-box" style="background:#FF0000"></div> Hujan Sangat Lebat : 100 - 150 mm/jam</div>
        <div class="legend-item"><div class="legend-box" style="background:#8000FF"></div> Hujan Ekstrem : > 150 mm/jam</div>
      </div>
    </div>

    <div class="card">
      <canvas id="chart" height="300"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const DATA_FILE = "prakiraan_DIY_full3jam.json";
    let DATA=null, chart=null;

    function parseRange(s){
      if(!s||s=="-") return [null,null];
      const m=s.match(/(-?\d+)\s*[–-]\s*(-?\d+)/);
      if(m) return [parseFloat(m[1]),parseFloat(m[2])];
      const n=parseFloat(s); return isNaN(n)?[null,null]:[n,n];
    }

    function extractDate(label){
      const parts=label.split(" ");
      if(parts.length>=4) return parts[1]+" "+parts[2]+" "+parts[3];
      return label;
    }

    function warnaCuaca(desc){
      if(!desc) return "#E0E0E0";
      desc=desc.toLowerCase();
      if(desc.includes("ringan")) return "#00FF00";
      if(desc.includes("sedang")) return "#FFFF00";
      if(desc.includes("lebat") && !desc.includes("sangat")) return "#FFA500";
      if(desc.includes("sangat lebat")) return "#FF0000";
      if(desc.includes("ekstrem")) return "#8000FF";
      return "#E0E0E0";
    }

    async function loadData(){
      const res=await fetch(DATA_FILE);
      DATA=await res.json();
      const kabSel=document.getElementById("kabSelect");
      kabSel.innerHTML=Object.keys(DATA).map(k=>`<option>${k}</option>`).join("");
      kabSel.addEventListener("change",()=>render(kabSel.value));
      render(Object.keys(DATA)[0]);
    }

    function render(kab){
      const slots=DATA[kab]||{};
      const labels=Object.keys(slots).sort((a,b)=>new Date(a.split("–")[0])-new Date(b.split("–")[0]));
      const tanggalUnik=[...new Set(labels.map(l=>extractDate(l)))];
      const dateSel=document.getElementById("dateSelect");
      dateSel.innerHTML=tanggalUnik.map(d=>`<option>${d}</option>`).join("");
      dateSel.onchange=()=>render(kab);
      const chosenDate=dateSel.value||tanggalUnik[0];

      const tbody=document.getElementById("tbody");
      const filtered=labels.filter(l=>extractDate(l)===chosenDate);
      tbody.innerHTML=filtered.map(l=>{
        const v=slots[l]; const bg=warnaCuaca(v.cuaca);
        return `<tr>
          <td>${l}</td>
          <td class="cuaca-cell" style="background:${bg}">${v.cuaca}</td>
          <td>${v.suhu}</td><td>${v.hum}</td>
        </tr>`;
      }).join("");

      document.getElementById("info").textContent=`${kab} — ${filtered.length} slot (${chosenDate})`;

      const x=[],tmin=[],tmax=[],hmin=[],hmax=[];
      filtered.forEach(l=>{
        const v=slots[l];
        x.push(l);
        const [a,b]=parseRange(v.suhu); tmin.push(a); tmax.push(b);
        const [c,d]=parseRange(v.hum); hmin.push(c); hmax.push(d);
      });
      drawChart(x,tmin,tmax,hmin,hmax);
    }

    function drawChart(x,tmin,tmax,hmin,hmax){
      const ctx=document.getElementById("chart").getContext("2d");
      if(chart) chart.destroy();
      chart=new Chart(ctx,{
        type:"line",
        data:{labels:x,datasets:[
          {label:"Suhu min",data:tmin,borderColor:"#1f77b4",tension:0.2,spanGaps:true},
          {label:"Suhu max",data:tmax,borderColor:"#ff7f0e",tension:0.2,spanGaps:true},
          {label:"Hum min",data:hmin,borderColor:"#2ca02c",tension:0.2,spanGaps:true,yAxisID:"y2"},
          {label:"Hum max",data:hmax,borderColor:"#d62728",tension:0.2,spanGaps:true,yAxisID:"y2"},
        ]},
        options:{interaction:{mode:"index",intersect:false},scales:{
          y:{title:{display:true,text:"Suhu (°C)"}},
          y2:{position:"right",grid:{drawOnChartArea:false},title:{display:true,text:"Kelembapan (%)"}}
        }}
      });
    }

    document.getElementById("toCsv").addEventListener("click",()=>{
      const kab=document.getElementById("kabSelect").value;
      const slots=DATA[kab]; 
      const labels=Object.keys(slots);
      const chosenDate=document.getElementById("dateSelect").value;
      const rows=[["kabupaten","waktu","cuaca","suhu","hum"]];
      labels.forEach(l=>{
        if(extractDate(l)===chosenDate){
          const v=slots[l]; rows.push([kab,l,v.cuaca,v.suhu,v.hum]);
        }
      });
      const csv=rows.map(r=>r.join(",")).join("\n");
      const a=document.createElement("a");
      a.href=URL.createObjectURL(new Blob([csv]));
      a.download=`${kab}_${chosenDate}.csv`;
      a.click();
    });

    loadData();
  </script>
</body>
</html>
